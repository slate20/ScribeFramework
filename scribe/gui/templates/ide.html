<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScribeEngine IDE</title>

    <!-- IDE Configuration -->
    <script>
        // Construct app base URL using current hostname and configured port
        // This allows the preview to work whether accessing locally or remotely
        const appPort = {{ app_port }};
        const appBase = `${window.location.protocol}//${window.location.hostname}:${appPort}`;

        window.IDE_CONFIG = {
            apiBase: '{{ api_base }}',
            appBase: appBase
        };
    </script>

    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css" integrity="sha512-+FrEXFgwhTBnPq6K6s3wO2koXT1z9YdPBDJru2s1iqLsa/FJcbvG9/eXGTvlf0vNqNgQP6LeLc8tILRmB6cGPA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="{{ url_for('gui.static', filename='css/ide.css') }}">
</head>
<body>
    <div id="ide-container">
        <!-- Header -->
        <header id="ide-header">
            <div class="header-left">
                <h1>ScribeEngine IDE</h1>
                <span id="project-name" class="project-name"></span>
            </div>
            <div class="header-right">
                <button id="save-btn" class="btn btn-primary" disabled>
                    <span class="icon">ðŸ’¾</span> Save (Ctrl+S)
                </button>
                <button id="refresh-preview-btn" class="btn">
                    <span class="icon">ðŸ”„</span> Refresh Preview
                </button>
                <button id="toggle-preview-btn" class="btn" title="Toggle Preview Panel">
                    <span class="icon">â—€</span>
                </button>
            </div>
        </header>

        <!-- Main content area -->
        <div id="ide-main">
            <!-- Sidebar: File Explorer -->
            <aside id="sidebar">
                <div class="sidebar-header">
                    <h2>Files</h2>
                    <div class="sidebar-actions">
                        <button id="refresh-files-btn" class="icon-btn" title="Refresh">ðŸ”„</button>
                    </div>
                </div>
                <div id="file-tree" class="file-tree">
                    <div class="loading">Loading files...</div>
                </div>
            </aside>

            <!-- Resizer between sidebar and editor -->
            <div class="resizer resizer-vertical" id="sidebar-resizer"></div>

            <!-- Editor Panel -->
            <main id="editor-panel">
                <div class="editor-tabs">
                    <div id="tabs-container" class="tabs-container">
                        <!-- Tabs will be added dynamically -->
                    </div>
                </div>
                <div id="editor-wrapper">
                    <div id="editor-placeholder" class="editor-placeholder">
                        <div class="placeholder-content">
                            <h2>Welcome to ScribeEngine IDE</h2>
                            <p>Select a file from the sidebar to start editing</p>
                            <div class="quick-tips">
                                <h3>Quick Tips:</h3>
                                <ul>
                                    <li><strong>Ctrl+S</strong> - Save current file</li>
                                    <li><strong>.stpl files</strong> - ScribeEngine templates with syntax highlighting</li>
                                    <li><strong>Live Preview</strong> - See your changes in real-time</li>
                                    <li><strong>Database Browser</strong> - Explore your app database</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div id="monaco-editor" style="display: none;"></div>
                </div>

                <!-- Status Bar -->
                <footer id="status-bar">
                    <div class="status-left">
                        <span id="status-message">Ready</span>
                    </div>
                    <div class="status-right">
                        <span id="cursor-position">Ln 1, Col 1</span>
                        <span id="file-language">-</span>
                    </div>
                </footer>
            </main>

            <!-- Resizer between editor and right panel -->
            <div class="resizer resizer-vertical" id="right-panel-resizer"></div>

            <!-- Right Panel: Live Preview / Database Browser -->
            <aside id="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-panel="preview">Preview</button>
                    <button class="panel-tab" data-panel="database">Database</button>
                    <button class="panel-tab" data-panel="routes">Routes</button>
                </div>

                <!-- Preview Panel -->
                <div id="preview-panel" class="panel-content active">
                    <div class="preview-controls">
                        <input type="text" id="preview-url" class="preview-url-input" placeholder="/route/path">
                        <button id="preview-go-btn" class="btn btn-sm">Go</button>
                    </div>
                    <div id="preview-frame-container">
                        <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
                    </div>
                    <div id="preview-error" class="preview-error" style="display: none;"></div>
                </div>

                <!-- Database Panel -->
                <div id="database-panel" class="panel-content">
                    <div class="database-controls">
                        <select id="table-select" class="table-select">
                            <option value="">Select a table...</option>
                        </select>
                        <button id="refresh-tables-btn" class="btn btn-sm">Refresh</button>
                    </div>
                    <div id="database-content">
                        <p class="placeholder-text">Select a table to view its data</p>
                    </div>
                </div>

                <!-- Routes Panel -->
                <div id="routes-panel" class="panel-content">
                    <div id="routes-list">
                        <p class="placeholder-text">Loading routes...</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="new-file-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>New File</h2>
            <input type="text" id="new-file-name" placeholder="filename.stpl">
            <div class="modal-actions">
                <button id="new-file-create-btn" class="btn btn-primary">Create</button>
                <button id="new-file-cancel-btn" class="btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="new-folder-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>New Folder</h2>
            <input type="text" id="new-folder-name" placeholder="folder-name">
            <div class="modal-actions">
                <button id="new-folder-create-btn" class="btn btn-primary">Create</button>
                <button id="new-folder-cancel-btn" class="btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CSRF Token for API requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <!-- Monaco Editor Loader -->
    <script>
        // Log when loader script starts
        console.log('HTML: Loading Monaco loader script...');
    </script>
    <!-- Try unpkg CDN as fallback -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"
            onerror="console.error('HTML: unpkg CDN failed, trying jsdelivr...');
                     var script = document.createElement('script');
                     script.src = 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js';
                     document.head.appendChild(script);"></script>
    <script>
        // Check if RequireJS loaded
        if (typeof require !== 'undefined') {
            console.log('HTML: RequireJS loaded successfully');
        } else {
            console.error('HTML: RequireJS failed to load from CDN!');
        }
    </script>

    <script src="{{ url_for('gui.static', filename='js/ide.js') }}"></script>
</body>
</html>
